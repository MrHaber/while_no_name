# Формат входных данных

Документ описывает структуру и назначение каждого JSON-файла набора входных данных.
Ключ для объединения таблиц: `product_code` (код ТН ВЭД/HS в виде строки без разделителей).
Денежные значения — в долларах США (USD). Масса — в тоннах (t), если не указано иное.

---

## 1) `Код, название, ставки.json` — Справочник товаров и ставок

Назначение. Справочник кодов товаров с человекочитаемыми названиями и тарифными ставками (текущая и связанная по ВТО).
Гранулярность. Одна запись на `product_code`.
Рекомендуемый первичный ключ. `product_code` (string).

Форма
```json
[
  {
    "product_code": "842810",
    "product_name": "Лифты",
    "tariff_current": 0.0,
    "tariff_bound_wto": 5.0
  }
]
```

Примечания
- `tariff_current` и `tariff_bound_wto` — доли процента (например, 6.5 означает 6.5%).
- Используется как измерение для подписей в интерфейсе и анализа мер; объединение по `product_code`.

Пример
```json
{
  "product_code": "847290",
  "product_name": "Банкоматы",
  "tariff_current": 0.0,
  "tariff_bound_wto": 0.0
}
```

---

## 2) `Объем и динамика импорта.json` — Объёмы импорта и динамика

Назначение. Совокупные объёмы импорта за 3 последних года по стоимости и массе, а также изменение к предыдущему году по стоимости.
Гранулярность. Одна запись на `product_code`.
Рекомендуемый первичный ключ. `product_code` (string).

Форма
```json
[
  {
    "product_code": "842810",
    "last_three_years": [
      { "year": 2022, "import_value_usd": 285385999.99999994, "import_value_tones": 85596.0 },
      { "year": 2023, "import_value_usd": 299993000.0,        "import_value_tones": 88119.0 },
      { "year": 2024, "import_value_usd": 306844000.0,        "import_value_tones": 86084.0 }
    ],
    "last_change_percent": 2.2837199534655808
  }
]
```

Примечания
- `import_value_tones` — масса в тоннах (орфография поля сохранена как в источнике).
- `last_change_percent` — темп изменения **стоимости** относительно предыдущего года.

Пример
```json
{
  "product_code": "847290",
  "last_three_years": [
    { "year": 2022, "import_value_usd": 292718000.0, "import_value_tones": 14996.0 },
    { "year": 2023, "import_value_usd": 190851000.0, "import_value_tones": 9801.0 },
    { "year": 2024, "import_value_usd": 207273000.0, "import_value_tones": 11330.0 }
  ],
  "last_change_percent": 8.604618262414135
}
```

---

## 3) `Средняя контрактная цена импорта.json` — Средние контрактные цены (топ-5 по стоимости)

Назначение. Для каждого товара и года содержит среднюю контрактную цену (USD/т) по пяти крупнейшим странам-поставщикам по стоимости.
Гранулярность. Товар × Год × Страна (только топ-5 по стоимости на год).
Рекомендуемый составной ключ. `product_code` + `year` + `country`.

Форма
```json
[
  {
    "product_code": "842810",
    "avg_contract_price_by_year": [
      {
        "year": 2024,
        "top5_by_value": [
          {
            "country": "Belarus",
            "import_value_usd": 100480000.0,
            "import_value_tones": 41784.0,
            "avg_contract_price_usd_per_tone": 2404.7482289871723
          },
          {
            "country": "Switzerland",
            "import_value_usd": 6395000.0,
            "import_value_tones": 858.0,
            "avg_contract_price_usd_per_tone": 7453.379953379954
          }
        ]
      }
    ]
  }
]
```

Примечания
- `avg_contract_price_usd_per_tone` может быть `null`, если `import_value_tones = 0` (деление невозможно).
- В списке только топ-5 стран по **стоимости** за соответствующий год.

---

## 4) `Географическая структура импорта.json` — Структура по странам-поставщикам

Назначение. Для каждого товара и года показывает итоговую стоимость импорта и разбиение по странам-поставщикам (стоимость, тоннаж, доля, признак дружественности).
Гранулярность. Товар × Год × Страна (включает широкий набор стран, не только топ-5).
Рекомендуемый составной ключ. `product_code` + `year` + `country`.

Форма
```json
[
  {
    "product_code": "842810",
    "geo_structure_by_year": [
      {
        "year": 2024,
        "total_import_value_usd": 306844000.0,
        "top_countries": [
          {
            "country": "Belarus",
            "import_value_usd": 100480000.0,
            "import_value_tones": 41784.0,
            "share_percent": 32.746281498090234,
            "is_friendly": true
          },
          {
            "country": "China",
            "import_value_usd": 86759000.0,
            "import_value_tones": 25690.0,
            "share_percent": 28.274628149809022,
            "is_friendly": true
          }
        ]
      }
    ]
  }
]
```

Примечания
- `share_percent` — доля от **годовой стоимости импорта** по товару.
- `is_friendly` — логический флаг (дружественная/недружественная страна).
- Для некоторых стран `import_value_tones` может быть 0 при отсутствии/недоступности веса.

---

## 5) `Объем и динамика производства.json` — Выпуск (производство) в стране

Назначение. Совокупная стоимость выпуска за 3 последних года и изменение к предыдущему году.
Гранулярность. Одна запись на `product_code`.
Рекомендуемый первичный ключ. `product_code` (string).

Форма
```json
[
  {
    "product_code": "842810",
    "last_three_years": [
      { "year": 2022, "production_value_usd": 286000000.0 },
      { "year": 2023, "production_value_usd": 300000000.0 },
      { "year": 2024, "production_value_usd": 307000000.0 }
    ],
    "last_change_percent": 2.3333333333333335
  }
]
```

Примечания
- Значения приведены в текущих USD на соответствующий год.
- Совместно с потреблением позволяет оценить профицит/дефицит.

---

## 6) `Объем и динамика потребления.json` — Явное потребление

Назначение. Совокупная стоимость явного потребления за 3 последних года и изменение к предыдущему году.
Гранулярность. Одна запись на `product_code`.
Рекомендуемый первичный ключ. `product_code` (string).

Форма
```json
[
  {
    "product_code": "842810",
    "last_three_years": [
      { "year": 2022, "consumtion_value_usd": 285000000.0 },
      { "year": 2023, "consumtion_value_usd": 299000000.0 },
      { "year": 2024, "consumtion_value_usd": 306000000.0 }
    ],
    "last_change_percent": 2.341137123745819
  }
]
```

Примечания
- Орфография поля сохранена: `consumtion_value_usd`.
- Для балансов и правил рекомендуется использовать вместе с импортом и производством.

---

## 7) `Рекомендуемые меры.json` — Результаты правил по мерам

Назначение. Рекомендуемые меры для каждого товара с пояснением причин и диагностическими полями.
Гранулярность. Одна запись на `product_code`.
Рекомендуемый первичный ключ. `product_code` (string).

Форма
```json
[
  {
    "product_code": "330300",
    "recommendation": "measures_suggested",
    "reason": [
      "Повышение ставки таможенной пошлины до уровня 35-50% в рамках национального контрсанкционного регулирования."
    ],
    "measures": ["Measure 2"],
    "_debug": {
      "tariff_current": 6.5,
      "tariff_wto": 6.5,
      "ns_share_percent": 95.50654904131942,
      "ns_growth_abs": 187222999.99999994,
      "ns_growth_pct": 55.52415241168235,
      "production_last": 657000000.0,
      "consumption_last": 224000000.0,
      "top1_country": "France",
      "top1_avg_price": 47213.65277321956,
      "other_avg_price_mean": 34718.883697893485
    }
  },
  {
    "product_code": "842810",
    "recommendation": "measures_suggested",
    "reason": [
      "Повышение ставки таможенной пошлины до уровня связывания в рамках Всемирной торговой организации (ВТО)."
    ],
    "measures": ["Measure 1"],
    "_debug": {
      "tariff_current": 0.0,
      "tariff_wto": 5.0,
      "ns_share_percent": 32.17107064175933,
      "ns_growth_abs": -561000.0,
      "ns_growth_pct": -0.5650912607276684,
      "production_last": 307000000.0,
      "consumption_last": 306000000.0,
      "top1_country": "Belarus",
      "top1_avg_price": 2404.7482289871723,
      "other_avg_price_mean": 15182.007454533483
    }
  },
  {
    "product_code": "847290",
    "recommendation": "measures_suggested",
    "reason": [
      "Расширение или инициирование применения преференциального режима в отношении товара в рамках государственных закупок."
    ],
    "measures": ["Measure 4"],
    "_debug": {
      "tariff_current": 0.0,
      "tariff_wto": 0.0,
      "ns_share_percent": 29.023558302335566,
      "ns_growth_abs": 3043999.9999999925,
      "ns_growth_pct": 5.3296914942045595,
      "production_last": 576000000.0,
      "consumption_last": 217000000.0,
      "top1_country": "China",
      "top1_avg_price": 17301.191499815748,
      "other_avg_price_mean": 33629.731576054284
    }
  }
]
```

Примечания
- `reason` теперь содержит сформулированные текстом предложения по регулированию (например, повышение пошлины до уровня связывания ВТО; повышение до 35–50% в рамках национального регулирования; расширение преференций в госзакупках).
- `measures` — коды мер из согласованного словаря (например, Measure 1, Measure 2, Measure 4).
- `_debug` — служебные показатели, используемые правилами принятия решения; состав полей может изменяться.

---

## Связи сущностей (joins)

```text
Код, название, ставки  (product_code) 1 — 1  Объем/динамика импорта (product_code)
                                     1 — 1  Объем/динамика производства (product_code)
                                     1 — 1  Объем/динамика потребления (product_code)
                                     1 — n  Средняя контрактная цена (product_code, year, country)
                                     1 — n  Географическая структура (product_code, year, country)
                                     1 — 1  Рекомендуемые меры (product_code)
```

Рекомендации по объединению
- Использовать `product_code` как мастер-ключ.
- Для годовых срезов объединять по паре (`product_code`, `year`); для страновых таблиц агрегировать по необходимости.
- Осторожно обращаться со значениями цен при `import_value_tones = 0`, чтобы избежать деления на ноль.

---

## Проверки целостности и качества

- Проверка схемы: наличие полей и соответствие типов указанным выше.
- Числовые проверки: все денежные поля неотрицательны; доли в диапазоне [0, 100].
- Согласованность:
  - В гео-таблицах сумма `share_percent` по странам за фиксированные (`product_code`, `year`) близка к 100%.
  - Для средних цен: `avg_contract_price_usd_per_tone ≈ import_value_usd / import_value_tones` при положительном тоннаже.
  - `last_change_percent` соответствует отношению последних двух лет соответствующего ряда.

---

## Версионирование и особенности наименований

- Сохранять исходные написания полей (например, `import_value_tones`, `consumtion_value_usd`) для совместимости.
- Названия стран воспроизводятся из источника (например, `Korea. Republic of`, `Taipei. Chinese`).
