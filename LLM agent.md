# NPA QA LLM Agent  
Однострочный интеллектуальный агент для поиска и ответов по нормативно-правовым актам (НПА) Федеральной таможенной службы РФ.  
Принимает естественные вопросы на русском языке и отвечает строго по данным из JSON-файла.  

---

## Возможности
- Понимает естественные запросы:  
  *«все приказы 2025 года»*, *«ссылка на приказ о личных делах»*, *«дата регистрации приказа №847»*  
- Работает офлайн, без внешних API.  
- Возвращает точные ответы из данных НПА, а не "галлюцинации".  
- Поддерживает синонимы, распознавание годов, номеров приказов, типов актов.  
- Имеет Swagger и ReDoc документацию:  
  - `/docs` — Swagger UI  
  - `/redoc` — ReDoc UI  

---

## Технологии
| Технология | Назначение |
|-------------|------------|
| **Python 3.11+** | Основной язык реализации логики и API |
| **FastAPI** | Создание REST API и схем OpenAPI |
| **Uvicorn** | ASGI-сервер, обеспечивает запуск FastAPI |
| **scikit-learn** | TF-IDF и cosine similarity для поиска по тексту |
| **BM25-эвристика** | Поисковый ранжирующий алгоритм для контекстного совпадения |
| **Pydantic** | Валидация запросов и ответов |
| **Dataclasses** | Упрощённое хранение записей документов |
| **Регулярные выражения** | Извлечение номеров, годов, типов |
| **JSON** | Формат хранения базы НПА |
| **Pathlib / OS** | Работа с путями к файлам |
| **Swagger / ReDoc** | Автоматическая документация API |

---

## Структура проекта

```
LLM agent/
│
├── customs_npa_api.py          # Главный API-сервер (FastAPI)
├── first_10.json               # База НПА (пример)
├── requirements.txt            # Зависимости проекта
└── README.md                   # Документация (этот файл)
```

---

## Установка

1. Клонировать или скачать проект.  
2. Создать виртуальное окружение:
```
python -m venv .venv
.venv\Scripts\activate  # Windows
source .venv/bin/activate  # Linux/macOS
```
3. Установить зависимости:
```
pip install -r requirements.txt
```

Если файла `requirements.txt` нет, создай его:
```
fastapi
uvicorn
scikit-learn
pydantic
```

---

## Подготовка данных

Файл базы должен называться `first_10.json` или быть указан через переменную окружения `JSON_PATH`.

Пример структуры JSON:
```
{
  "documents": [
    {
      "title": "Приказ Федеральной таможенной службы от 09.09.2025 № 847",
      "description": "Об утверждении Порядка ведения личных дел сотрудников таможенных органов Российской Федерации",
      "registration_date": "13.10.2025",
      "download_url": "http://publication.pravo.gov.ru/file/pdf?eoNumber=0001202510140004",
      "pdf_filename": "Приказ_ФТС_847.pdf"
    }
  ]
}
```

---

## Запуск API

1. Перейди в директорию с проектом:
```
cd "C:\Users\<USERNAME>\Desktop\Хак 17.10.2025\LLM agent"
```
2. Запусти сервер:
```
uvicorn customs_npa_api:app --host 0.0.0.0 --port 8010
```
3. После запуска появится сообщение:
```
INFO:     Application startup complete.
Uvicorn running on http://0.0.0.0:8010
```
4. Проверка работоспособности:
```
curl http://127.0.0.1:8010/health
```
Ожидаемый ответ:
```
{
  "status": "ok",
  "docs": 10,
  "json_path": "C:\\Users\\...\\first_10.json"
}
```

---

## Использование API

### Проверка статуса
```
GET /health
```
Возвращает статус сервиса, путь к базе и количество документов.

**Пример ответа:**
```
{
  "status": "ok",
  "docs": 10,
  "json_path": "C:\\LLM agent\\first_10.json"
}
```

### Основной эндпоинт — `/ask`
Отправь естественный вопрос и получи короткий ответ.

**Пример запроса (cURL):**
```
curl -X POST http://127.0.0.1:8010/ask \
  -H "Content-Type: application/json" \
  -d "{\"query\": \"какая дата регистрации приказа №847?\"}"
```
**Пример ответа:**
```
{
  "answer": "13.10.2025"
}
```

---

## Примеры запросов
```
1. Все НПА 2025 года  
2. Какие приказы ФТС изданы в 2025 году  
3. Как называется приказ о личных делах сотрудников  
4. Ссылка на приказ №847  
5. Когда зарегистрирован приказ о магазинах беспошлинной торговли  
6. Все документы за 2023 год  
7. Какие документы касаются таможенных складов  
8. Какой тип акта у приказа №700  
9. Какие НПА содержат 2025 год в названии  
10. Дай список всех приказов
```

---

## Как бот работает

1. Загружает JSON с НПА.  
2. Преобразует тексты документов в числовые векторы через TF-IDF.  
3. При поступлении вопроса:
   - нормализует текст, подставляет синонимы;  
   - извлекает годы, номера, типы документов;  
   - вычисляет сходство cosine similarity + BM25;  
   - выбирает наиболее подходящий документ.  
4. В зависимости от вопроса (по словам “дата”, “номер”, “ссылка”) выбирает соответствующее поле.  
5. Если уверенности мало — возвращает fallback:

```
Не могу однозначно ответить по данным из базы. Уточните формулировку (тип акта, ключевые слова, год/номер).
```

---

## Документация API

После запуска сервера доступны интерфейсы:

| URL | Назначение |
|-----|-------------|
| `/docs` | Swagger UI (интерактивное тестирование запросов) |
| `/redoc` | ReDoc документация |
| `/openapi.json` | JSON-схема OpenAPI |

---

## Интеграция в другой код

Можно использовать API как модуль:
```
from customs_npa_api import OneShotQAService

svc = OneShotQAService(json_path="path/to/first_10.json")
print(svc.ask("ссылка на приказ о личных делах сотрудников"))
```

Или обращаться к нему как к REST-сервису:
```
import requests

resp = requests.post("http://127.0.0.1:8010/ask", json={"query": "все НПА 2025 года"})
print(resp.json()["answer"])
```

---

## Переменные окружения
| Переменная | Описание | Пример |
|-------------|-----------|--------|
| `JSON_PATH` | Путь к JSON-файлу с базой НПА | `set JSON_PATH=C:\data\npa.json` |

---

## Fallback-механизм
Если бот не уверен в ответе или не нашёл данных:
```
Не могу однозначно ответить по данным из базы. Уточните формулировку (тип акта, ключевые слова, год/номер).
```

---

## Типичные ошибки
| Проблема | Решение |
|-----------|----------|
| `FileNotFoundError: first_10.json not found` | Укажи путь через `JSON_PATH` или положи файл рядом с кодом |
| `422 Unprocessable Content` | Неверный JSON в теле запроса — проверь кавычки |
| `ImportError: cannot import name 'build_app'` | Убедись, что используешь актуальный `customs_npa_api.py` |
| `AttributeError` при запуске | Проверь, что установлены все библиотеки (`pip install -r requirements.txt`) |

---

## Пример запуска из командной строки
```
python customs_npa_api.py "все НПА 2025 года"
```
Ответ в консоли:
```
НПА за 2025: Приказ №847; Приказ №776; Приказ №729 ...
```
